<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.fh.mapper.dsno1.system.UsersMapper">

	<resultMap type="User" id="userAndRoleResultMap">
		<id column="USER_ID" property="USER_ID" />
		<result column="USERNAME" property="USERNAME" />
		<result column="PASSWORD" property="PASSWORD" />
		<result column="NAME" property="NAME" />
		<result column="LAST_LOGIN" property="LAST_LOGIN" />
		<result column="IP" property="IP" />
		<result column="STATUS" property="STATUS" />
		<result column="SKIN" property="SKIN" />
		<result column="ROLE_IDS" property="ROLE_IDS" />
		<result column="OPEN_ID" property="OPEN_ID" />
		<result column="PHONE" property="PHONE" />
		<association property="role" column="ROLE_ID"
			javaType="Role">
			<id column="ROLE_ID" property="ROLE_ID" />
			<result column="ROLE_NAME" property="ROLE_NAME" />
			<result column="ROLE_RIGHTS" property="RIGHTS" />
			<result column="ADD_QX" property="ADD_QX" />
			<result column="DEL_QX" property="DEL_QX" />
			<result column="EDIT_QX" property="EDIT_QX" />
			<result column="CHA_QX" property="CHA_QX" />
		</association>
	</resultMap>
	<resultMap type="User" id="userResultMap">
		<id column="USER_ID" property="USER_ID" />
		<result column="USERNAME" property="USERNAME" />
		<result column="PASSWORD" property="PASSWORD" />
		<result column="NAME" property="NAME" />
		<result column="LAST_LOGIN" property="LAST_LOGIN" />
		<result column="IP" property="IP" />
		<result column="STATUS" property="STATUS" />
		<result column="ROLE_ID" property="ROLE_ID" />
		<result column="SKIN" property="SKIN" />
		<result column="ROLE_IDS" property="ROLE_IDS" />
		<result column="REGISTERED_ID" property="REGISTERED_ID" />
		<result column="OPEN_ID" property="OPEN_ID" />
	</resultMap>

	<!--用户表名 -->
	<sql id="tableName">
		SYS_USER
	</sql>

	<!--角色表名 -->
	<sql id="roleTableName">
		SYS_ROLE
	</sql>

	<!--员工表名 -->
	<sql id="staffTableName">
		OA_STAFF
	</sql>

	<!--白名单表名 -->
	<sql id="registeredTableName">
		OA_REGISTERED_LIST
	</sql>

	<!-- 字段 -->
	<sql id="Field">
		USER_ID,
		USERNAME,
		PASSWORD,
		NAME,
		ROLE_ID,
		LAST_LOGIN,
		IP,
		STATUS,
		BZ,
		SKIN,
		EMAIL,
		NUMBER,
		PHONE,
		ROLE_IDS,
		REGISTERED_ID,
		VERSION,
		CID,
		OPEN_ID
	</sql>

	<!-- 字段值 -->
	<sql id="FieldValue">
		#{USER_ID},
		#{USERNAME},
		#{PASSWORD},
		#{NAME},
		#{ROLE_ID},
		#{LAST_LOGIN},
		#{IP},
		#{STATUS},
		#{BZ},
		#{SKIN},
		#{EMAIL},
		#{NUMBER},
		#{PHONE},
		#{ROLE_IDS},
		#{REGISTERED_ID},
		#{VERSION},
		#{CID},
		#{OPEN_ID}
	</sql>

	<!-- 通过USERNAME获取数据 -->
	<select id="findByUsername" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		where
		USERNAME = #{USERNAME}
		and
		STATUS = '0'
	</select>

	<!-- 通过OPENID获取数据-->
	<select id="findByOpenId"  parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		where
		OPEN_ID = #{OPEN_ID}
		and
		STATUS = '0'
	</select>

	<!-- 通过NUMBER(身份证号)获取数据 -->
	<select id="findByNumber" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		where
		NUMBER = #{NUMBER}
		and
		STATUS = '0'
	</select>

	<!-- 通过用户ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		where
		USER_ID = #{USER_ID}
	</select>

	<!-- 通过邮箱获取数据 -->
	<select id="findByEmail" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include> U
		where U.STATUS='0'
		<if test="EMAIL != null and EMAIL != ''">
			AND U.EMAIL = #{EMAIL}
		</if>
		<if test="USERNAME != null and USERNAME != ''">
			AND U.USERNAME = #{USERNAME}
		</if>
		<if test="NAME != null and NAME != ''">
			AND U.NAME = #{NAME}
		</if>
	</select>

	<!-- 通过编码获取数据 -->
	<select id="findByNumbe" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		where
		NUMBER = #{NUMBER}
		<if test="USERNAME != null and USERNAME != ''">
			and USERNAME != #{USERNAME}
		</if>
	</select>

	<!-- 列出某角色下的所有用户 -->
	<select id="listAllUserByRoldId" parameterType="pd"
		resultType="pd">
		select USER_ID
		from
		<include refid="tableName"></include>
		where
		ROLE_ID = #{ROLE_ID}
	</select>

	<!-- 新增用户 -->
	<insert id="saveUser" parameterType="pd">
		insert into
		<include refid="tableName"></include>
		(
		<include refid="Field"></include>
		) values (
		<include refid="FieldValue"></include>
		)
	</insert>

	<!-- 修改 -->
	<update id="editUser" parameterType="pd">
		update
		<include refid="tableName"></include>
		set NAME = #{NAME},
		ROLE_ID = #{ROLE_ID},
		ROLE_IDS = #{ROLE_IDS},
		BZ =
		#{BZ},
		EMAIL = #{EMAIL},
		NUMBER = #{NUMBER},
		PHONE = #{PHONE},
		OPEN_ID = #{OPEN_ID}
		<if test="PASSWORD != null and PASSWORD != ''">
			,PASSWORD = #{PASSWORD}
		</if>
		<if test="STATUS != null and STATUS != ''">
			,STATUS = #{STATUS}
		</if>
		where
		USER_ID = #{USER_ID}
	</update>

	<!-- 用户列表 -->
	<select id="userlistPage" parameterType="page" resultType="pd">
		select u.USER_ID,
		u.USERNAME,
		u.PASSWORD,
		u.LAST_LOGIN,
		u.NAME,
		u.IP,
		u.EMAIL,
		u.NUMBER,
		u.PHONE,
		r.ROLE_ID,
		r.ROLE_NAME
		from
		<include refid="tableName"></include>
		u,
		<include refid="roleTableName"></include>
		r
		where u.ROLE_ID = r.ROLE_ID
		and u.USERNAME != 'admin'
		and r.PARENT_ID =
		'1'
		and u.STATUS = '0'
		<if test="pd.KEYWORDS!= null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			u.USERNAME LIKE CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.EMAIL
			LIKE CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.NUMBER LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.NAME LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.PHONE LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			)
		</if>
		<if test="pd.ROLE_ID != null and pd.ROLE_ID != ''">		<!-- 角色检索 -->
			and u.ROLE_ID=#{pd.ROLE_ID}
		</if>
		<if test="pd.STRARTTIME!=null and pd.STRARTTIME!=''">	<!-- 登录时间检索 -->
			and u.LAST_LOGIN &gt;= #{pd.STRARTTIME}
		</if>
		<if test="pd.ENDTIME!=null and pd.ENDTIME!=''">		 	<!-- 登录时间检索 -->
			and u.LAST_LOGIN &lt;= #{pd.ENDTIME}
		</if>
		order by u.LAST_LOGIN desc
	</select>

	<!-- 用户列表(全部) -->
	<select id="listAllUser" parameterType="pd" resultType="pd">
		select u.USER_ID,
		u.USERNAME,
		u.PASSWORD,
		u.LAST_LOGIN,
		u.NAME,
		u.IP,
		u.EMAIL,
		u.NUMBER,
		u.PHONE,
		r.ROLE_ID,
		r.ROLE_NAME
		from
		<include refid="tableName"></include>
		u,
		<include refid="roleTableName"></include>
		r
		where u.ROLE_ID = r.ROLE_ID
		and u.USERNAME != 'admin'
		and r.PARENT_ID =
		'1'
		and u.STATUS = '0'
		<if test="KEYWORDS != null and KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			u.USERNAME LIKE CONCAT(CONCAT('%', #{KEYWORDS}),'%')
			or
			u.EMAIL
			LIKE CONCAT(CONCAT('%', #{KEYWORDS}),'%')
			or
			u.NUMBER LIKE
			CONCAT(CONCAT('%', #{KEYWORDS}),'%')
			or
			u.NAME LIKE CONCAT(CONCAT('%',
			#{KEYWORDS}),'%')
			or
			u.PHONE LIKE CONCAT(CONCAT('%', #{KEYWORDS}),'%')
			)
		</if>
		<if test="ROLE_ID != null and ROLE_ID != ''"><!-- 角色检索 -->
			and u.ROLE_ID=#{ROLE_ID}
		</if>
		<if test="STRARTTIME!=null and STRARTTIME!=''"><!-- 登录时间检索 -->
			and u.LAST_LOGIN &gt;= #{STRARTTIME}
		</if>
		<if test="ENDTIME!=null and ENDTIME!=''"><!-- 登录时间检索 -->
			and u.LAST_LOGIN &lt;= #{ENDTIME}
		</if>
		order by u.LAST_LOGIN desc
	</select>

	<!-- 根据角色编码查询拥有该角色的用户列表 -->
	<select id="listAllUserByRNUMBER" parameterType="pd"
		resultType="pd">
		SELECT
		SU.USERNAME
		FROM
		sys_user SU
		WHERE
		SU.ROLE_IDS LIKE
		CONCAT(
		'%',
		(
		SELECT
		SR.ROLE_ID
		FROM
		sys_role SR
		WHERE
		SR.RNUMBER =
		#{RNUMBER}
		),
		'%'
		)
	</select>

	<!-- 通过用户ID获取用户信息和角色信息 -->
	<select id="getUserAndRoleById" parameterType="String"
		resultMap="userAndRoleResultMap">
		select u.USER_ID,
		u.USERNAME,
		u.NAME,
		u.PASSWORD,
		u.PHONE,
		u.SKIN,
		u.NUMBER,
		u.ROLE_IDS,
		r.ROLE_ID,
		r.ROLE_NAME,
		r.RIGHTS as ROLE_RIGHTS,
		r.ADD_QX,
		r.DEL_QX,
		r.EDIT_QX,
		r.CHA_QX
		from
		<include refid="tableName"></include>
		u
		left join
		<include refid="roleTableName"></include>
		r
		on u.ROLE_ID=r.ROLE_ID
		where u.STATUS=0
		and u.USER_ID=#{USER_ID}
	</select>

	<!-- 存入IP -->
	<update id="saveIP" parameterType="pd">
		update
		<include refid="tableName"></include>
		set
		IP = #{IP},
		LAST_LOGIN = #{LAST_LOGIN},
		VERSION = #{VERSION},
		CID =
		#{CID}
		where
		USERNAME = #{USERNAME}
	</update>

	<!-- 保存用户皮肤 -->
	<update id="saveSkin" parameterType="pd">
		update
		<include refid="tableName"></include>
		set
		SKIN = #{SKIN}
		where USERNAME = #{USERNAME}
	</update>

	<!-- 删除用户 -->
	<delete id="deleteUser" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where
		USER_ID = #{USER_ID}
		and
		USER_ID != '1'
	</delete>

	<!-- 批量删除用户 -->
	<delete id="deleteAllUser" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where
		USER_ID in
		<foreach item="item" index="index" collection="array" open="("
			separator="," close=")">
			#{item}
		</foreach>
		and
		USER_ID != '1'
	</delete>

	<!-- 用户列表(弹窗选择用) -->
	<select id="userBystafflistPage" parameterType="page"
		resultType="pd">
		select u.USER_ID,
		u.USERNAME,
		u.PASSWORD,
		u.LAST_LOGIN,
		u.NAME,
		u.IP,
		u.EMAIL,
		u.NUMBER,
		u.PHONE,
		u.BZ,
		r.ROLE_ID,
		r.ROLE_NAME,
		s.DEPARTMENT_ID,
		d.`NAME` AS DEPARTMENT_NAME
		from
		<include refid="tableName"></include>
		u,
		<include refid="roleTableName"></include>
		r,
		<include refid="staffTableName"></include>
		s
		LEFT JOIN oa_department d ON s.DEPARTMENT_ID = d.DEPARTMENT_ID
		where
		u.ROLE_ID = r.ROLE_ID
		and u.USERNAME = s.USER_ID
		and u.USERNAME !=
		'admin'
		and r.PARENT_ID = '1'
		and u.STATUS = '0'
		<if test="pd.KEYWORDS!= null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			u.USERNAME LIKE CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.EMAIL
			LIKE CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.NUMBER LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.NAME LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			u.PHONE LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			)
		</if>
		<if test="pd.ROLE_ID != null and pd.ROLE_ID != ''"><!-- 角色检索 -->
			and u.ROLE_ID=#{pd.ROLE_ID}
		</if>
		<if test="pd.STRARTTIME!=null and pd.STRARTTIME!=''">	<!-- 登录时间检索 -->
			and u.LAST_LOGIN &gt;= #{pd.STRARTTIME}
		</if>
		<if test="pd.ENDTIME!=null and pd.ENDTIME!=''">		 	<!-- 登录时间检索 -->
			and u.LAST_LOGIN &lt;= #{pd.ENDTIME}
		</if>
		<if test="pd.DEPT!=null and pd.DEPT!=''">		 	<!-- 部门检索 -->
			and s.DEPARTMENT_ID in ${pd.DEPT}
		</if>
		order by u.LAST_LOGIN desc
	</select>

	<!-- 查询指定部门下未审批的申请注册用户 -->
	<select id="notApprovedUserlistPage" parameterType="page"
		resultType="pd">
		select
		su.USER_ID AS USER_ID,
		su.BZ AS BZ,
		su.`NAME` AS NAME,
		os.STAFF_ID
		AS STAFF_ID,
		os.SFID AS ID_CARD,
		os.JOBTYPE AS JOBTYPE_ID,
		os.DEPARTMENT_ID AS DEPARTMENT_ID,
		od1.`NAME` AS JOBTYPE_NAME,
		od2.`NAME` AS DEPARTMENT_NAME,
		reg.LABORRELATION,
		reg.SERVICESDEPARTMENT,
		reg.EMPLOYEETYPE
		from
		<include refid="tableName"></include>
		su
		LEFT JOIN
		<include refid="staffTableName"></include>
		os
		ON su.USERNAME = os.USER_ID
		LEFT JOIN oa_department od1 ON os.JOBTYPE
		= od1.DEPARTMENT_ID
		LEFT
		JOIN oa_department od2 ON os.DEPARTMENT_ID =
		od2.DEPARTMENT_ID
		LEFT
		JOIN
		<include refid="registeredTableName"></include>
		reg
		ON su.`NUMBER` = reg.CARD
		where su.`STATUS` = '2'
		<if test="pd.DEPARTMENT_ID!= null and pd.DEPARTMENT_ID != ''">
			AND (od2.DEPARTMENT_ID = #{pd.DEPARTMENT_ID}
			OR od2.DEPARTMENT_ID IN
			${pd.DEPARTMENT_IDS})
			<!-- #引用会在变量前后自动添加'',$引用不会 -->
		</if><!-- 部门查询条件 -->
		<if test="pd.KEYWORDS!= null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			su.USERNAME LIKE CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			su.EMAIL LIKE CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			su.NUMBER LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			su.NAME LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			or
			su.PHONE LIKE
			CONCAT(CONCAT('%', #{pd.KEYWORDS}),'%')
			)
		</if>
		order by su.USER_ID desc
	</select>

	<!-- 查询当前用户的主职和副职角色 -->
	<select id="getUserRoles" parameterType="pd" resultType="pd">
		SELECT SU.ROLE_ID,SU.ROLE_IDS
		FROM
		<include refid="tableName"></include>
		SU
		WHERE SU.`STATUS` = '0'
		<if test="USERNAME != null and USERNAME != ''">
		AND SU.USERNAME = #{USERNAME}
		</if>
		LIMIT 1
	</select>

	<!-- 查询指定角色组下所有成员 -->
	<select id="getAllMember" parameterType="pd" resultType="pd">
		SELECT SU.USER_ID,SU.USERNAME
		FROM
		<include refid="tableName"></include>
		SU
		WHERE SU.`STATUS` = '0'
		<if test="ROLE_IDS != null and ROLE_IDS != ''">
		AND SU.ROLE_IDS LIKE CONCAT(CONCAT('%', #{ROLE_IDS}),'%')
		</if>
	</select>
</mapper>
